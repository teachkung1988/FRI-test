<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>æ–°æ±è³‡å„ªç­è¤‡è©¦é›†è¨“ - æ™ºåŠ›æ¸¬é©— FRI æµé«”æ¨ç†</title>
    <meta name="author" content="BRIAN SHEN">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #pdf-canvas { border: 2px solid #e5e7eb; max-width: 100%; border-radius: 8px; }
        .active-btn { background-color: #2563eb !important; color: white; border-color: #1e40af !important; }
        
        
        @media print {
            @page { size: A4; margin: 1.5cm; }
            body { background: white; }
            body * { visibility: hidden; }
            #result-section, #result-section * { visibility: visible; }
            #result-section { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            
            .report-header { margin-bottom: 2cm; page-break-after: avoid; }
        }
        .ready-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>

<body class="bg-slate-50 min-h-screen p-5">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-indigo-600">
            <span class="block">æ–°æ±è³‡å„ªç­è¤‡è©¦é›†è¨“</span>
            <span class="block text-2xl mt-1">æ™ºåŠ›æ¸¬é©—</span>
            <span class="block text-xl mt-1" style="color: #1b4332;">FRI æµé«”æ¨ç†</span>
        </h1>

        <div id="setup-section" class="space-y-6">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
                <h3 class="font-bold text-blue-700 mb-2">ğŸ“¢ ç›£è€ƒè€å¸«è¨­å®š</h3>
                <p class="text-blue-800 text-sm">è«‹å®ŒæˆåŸºæœ¬è¨­å®šï¼Œéš¨å¾Œäº¤çµ¦å­¸ç”Ÿé»æ“Šæº–å‚™é é¢ã€‚</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="pdf-upload-row">
                <div class="md:col-span-2">
                    <label class="block font-bold text-gray-700 mb-1">å­¸ç”Ÿå§“åï¼š</label>
                    <input type="text" id="student-name" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“å" class="w-full border p-2 rounded-lg bg-yellow-50 focus:ring-2 focus:ring-yellow-400 outline-none">
                </div>
                <div id="pdf-upload-cell">
                    <label class="block font-bold text-gray-700 mb-1">ä¸Šå‚³ PDF é¡Œç›®å·ï¼š</label>
                    <input type="file" id="pdf-upload" accept="application/pdf" class="w-full border p-2 rounded-lg">
                </div>
                <div>
                    <label class="block font-bold text-gray-700 mb-1">é™åˆ¶æ™‚é–“ (åˆ†é˜)ï¼š</label>
                    <input type="number" id="timer-setting" value="40" class="w-full border p-2 rounded-lg">
                </div>
            </div>
            <div id="embedded-pdf-notice" class="hidden bg-green-50 border-l-4 border-green-500 p-3 rounded text-sm text-green-800 mb-4">
                âœ“ å·²ä½¿ç”¨å…§å»ºé¡Œæœ¬ï¼Œç„¡éœ€ä¸Šå‚³ PDFã€‚
            </div>
            <div class="hidden">
                <textarea id="correct-answers">A,B,C,B,D,A,C,C,B,C,D,C,B,C,D,A,D,C,B,C,2,4,6,4,3,5,1,5,6,3,4,2,1,2,3,5,1,5,5,1,4,1,3,2,4,5,3,5,2,1,4,3,5,2,4,1,5,3,1,4,2,4,1,2,5,1,3,2,4,5,2,4,1,3,5,4,1,4,3,5</textarea>
            </div>
            
            <button id="start-btn" onclick="goToReadyScreen()" disabled class="w-full py-4 rounded-xl font-bold text-lg shadow-md transition bg-gray-400 cursor-not-allowed text-black">
                è«‹å…ˆè¼¸å…¥å§“åä¸¦ä¸Šå‚³æª”æ¡ˆ
            </button>
        </div>

        <div id="ready-section" class="hidden py-10 text-center space-y-8">
            <div class="ready-bg p-8 rounded-3xl text-white shadow-2xl">
                <h2 class="text-2xl font-bold mb-2">ä½ å¥½ï¼Œ<span id="ready-student-name"></span>ï¼</h2>
                <p>æº–å‚™å¥½é–‹å§‹æ¸¬é©—äº†å—ï¼Ÿ</p>
            </div>
            <div class="bg-gray-50 p-6 rounded-2xl border-2 border-dashed border-gray-300 text-left max-w-md mx-auto text-sm space-y-2">
                <p>â±ï¸ æ™‚é–“ï¼š<span id="ready-timer-info"></span> åˆ†é˜</p>
                <p>ğŸ“– é¡Œæ•¸ï¼šå…± 80 é¡Œ</p>
            </div>
            <button onclick="startActualQuiz()" class="w-full max-w-sm py-6 bg-indigo-600 text-white rounded-2xl font-black text-2xl shadow-xl hover:bg-indigo-700 transform hover:scale-105 transition-all">
                ğŸš€ é–‹å§‹è€ƒè©¦ï¼
            </button>
        </div>

        <div id="quiz-section" class="hidden">
            <div class="flex justify-between items-center mb-4 bg-indigo-50 p-4 rounded-lg">
                <div>
                    <div id="student-display" class="text-sm text-indigo-700 font-bold"></div>
                    <span id="page-info" class="text-lg font-bold text-indigo-900">è¼‰å…¥ä¸­...</span>
                </div>
                <div class="text-right">
                    <div class="text-xl font-mono font-bold text-red-500" id="timer-display">00:00</div>
                    <div class="text-xs text-gray-500" id="page-timer">æœ¬é¡Œç”¨æ™‚: 0 ç§’</div>
                </div>
            </div>
            <div class="flex justify-center mb-6">
                <canvas id="pdf-canvas"></canvas>
            </div>
            <div class="flex flex-col items-center space-y-4">
                <div class="flex flex-wrap justify-center gap-3">
                    <button onclick="selectOption('A')" class="opt-btn w-14 h-14 text-xl border-2 border-indigo-400 rounded-full font-bold">A</button>
                    <button onclick="selectOption('B')" class="opt-btn w-14 h-14 text-xl border-2 border-indigo-400 rounded-full font-bold">B</button>
                    <button onclick="selectOption('C')" class="opt-btn w-14 h-14 text-xl border-2 border-indigo-400 rounded-full font-bold">C</button>
                    <button onclick="selectOption('D')" class="opt-btn w-14 h-14 text-xl border-2 border-indigo-400 rounded-full font-bold">D</button>
                </div>
                <div class="flex flex-wrap justify-center gap-2">
                    <button onclick="selectOption('1')" class="opt-btn w-12 h-12 text-lg border-2 border-emerald-400 rounded-lg font-bold">1</button>
                    <button onclick="selectOption('2')" class="opt-btn w-12 h-12 text-lg border-2 border-emerald-400 rounded-lg font-bold">2</button>
                    <button onclick="selectOption('3')" class="opt-btn w-12 h-12 text-lg border-2 border-emerald-400 rounded-lg font-bold">3</button>
                    <button onclick="selectOption('4')" class="opt-btn w-12 h-12 text-lg border-2 border-emerald-400 rounded-lg font-bold">4</button>
                    <button onclick="selectOption('5')" class="opt-btn w-12 h-12 text-lg border-2 border-emerald-400 rounded-lg font-bold">5</button>
                    <button onclick="selectOption('6')" class="opt-btn w-12 h-12 text-lg border-2 border-emerald-400 rounded-lg font-bold">6</button>
                </div>
                <div class="flex space-x-4 w-full pt-2">
                    <button onclick="prevPage()" class="flex-1 py-3 bg-gray-200 rounded-lg">ä¸Šä¸€é¡Œ</button>
                    <button onclick="nextPage()" class="flex-1 py-3 bg-gray-200 rounded-lg">ä¸‹ä¸€é¡Œ</button>
                </div>
                <button id="finish-btn" onclick="finishQuiz()" style="display:none" class="w-full py-4 bg-green-500 text-white rounded-xl font-black text-xl shadow-lg">äº¤å·ä¸¦æŸ¥çœ‹çµæœ</button>
            </div>
        </div>

        <div id="result-section" class="hidden mt-10">
            <div class="report-header text-center mb-8 pb-6 border-b-2 border-gray-100">
                <h2 class="text-2xl font-bold text-gray-800">æµé«”æ¨ç†æ¸¬é©—å ±å‘Š</h2>
                <p class="text-lg mt-2">å­¸ç”Ÿï¼š<span id="result-name" class="font-bold text-indigo-600"></span></p>
                <p class="text-3xl font-black mt-2 text-red-600">å¾—åˆ†ï¼š<span id="final-score"></span> / 80</p>
                <p class="text-sm text-gray-400 mt-1">ç”¢å‡ºæ—¥æœŸï¼š<span id="report-date"></span></p>
            </div>
            
            
            <div id="result-actions" class="hidden space-y-4 no-print mt-10">
                <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-400 text-sm text-orange-800">
                    ğŸ’¡ é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¾Œï¼Œåœ¨å°è¡¨æ©Ÿç›®æ¨™è«‹é¸æ“‡<strong>ã€Œå¦å­˜ç‚º PDFã€</strong>ã€‚å»ºè­°è¨­å®šç‚º A4 å°ºå¯¸ã€‚
                </div>
                <button onclick="window.print()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-indigo-700">
                    ğŸ’¾ å„²å­˜ PDF å ±å‘Š
                </button>
                <button onclick="location.reload()" class="w-full py-3 bg-gray-400 text-white rounded-xl">é‡æ–°æ¸¬é©—</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        // è‹¥æœ‰å…§åµŒé¡Œæœ¬ï¼Œæ­¤è®Šæ•¸æœƒç”±åˆä½µè…³æœ¬å¡«å…¥ base64 å­—ä¸²
        var EMBEDDED_PDF_BASE64 = null;
        // ç¶²é ç‰ˆï¼šå¾åŒç›®éŒ„è‡ªå‹•è¼‰å…¥çš„ PDFï¼ˆç”¨ http é–‹æ­¤é æ™‚æœƒè‡ªå‹•æŠ“ï¼‰
        var AUTO_LOADED_PDF_ARRAY = null;

        let pdfDoc = null, currentPage = 1, userAnswers = [], userAnswerStartTimes = [], userPageDurations = [], correctAnswers = [], studentName = "", timeLimitMinutes = 40;
        let timerInterval = null, pageTimerInterval = null, pdfDataArray = null;

        function recordCurrentPageDuration() {
            if (currentPage >= 1 && currentPage <= (userAnswerStartTimes.length || 0) && userAnswerStartTimes[currentPage - 1] != null) {
                if (!userPageDurations[currentPage - 1]) userPageDurations[currentPage - 1] = Math.floor((Date.now() - userAnswerStartTimes[currentPage - 1]) / 1000);
            }
        }

        function hasEmbeddedPdf() { return typeof EMBEDDED_PDF_BASE64 === 'string' && EMBEDDED_PDF_BASE64.length > 0; }
        function hasAutoLoadedPdf() { return AUTO_LOADED_PDF_ARRAY && AUTO_LOADED_PDF_ARRAY.length > 0; }
        function hasPdfReady() { return hasEmbeddedPdf() || hasAutoLoadedPdf(); }

        function checkSetupCompletion() {
            const name = document.getElementById('student-name').value.trim();
            const file = document.getElementById('pdf-upload').files.length > 0;
            const btn = document.getElementById('start-btn');
            const needFile = !hasPdfReady();
            if (name && (file || !needFile)) {
                btn.disabled = false;
                btn.className = "w-full py-4 rounded-xl font-bold text-lg shadow-md transition bg-indigo-500 text-white";
                btn.textContent = "è¨­å®šå®Œæˆï¼Œé€²å…¥æº–å‚™ç•«é¢";
            }
        }

        function goToReadyScreen() {
            studentName = document.getElementById('student-name').value.trim();
            timeLimitMinutes = parseInt(document.getElementById('timer-setting').value);
            correctAnswers = document.getElementById('correct-answers').value.toUpperCase().replace(/\s/g, '').split(',');
            if (hasEmbeddedPdf()) {
                const binary = atob(EMBEDDED_PDF_BASE64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                pdfDataArray = bytes;
                document.getElementById('ready-student-name').textContent = studentName;
                document.getElementById('ready-timer-info').textContent = timeLimitMinutes;
                document.getElementById('setup-section').classList.add('hidden');
                document.getElementById('ready-section').classList.remove('hidden');
            } else if (hasAutoLoadedPdf()) {
                pdfDataArray = AUTO_LOADED_PDF_ARRAY;
                document.getElementById('ready-student-name').textContent = studentName;
                document.getElementById('ready-timer-info').textContent = timeLimitMinutes;
                document.getElementById('setup-section').classList.add('hidden');
                document.getElementById('ready-section').classList.remove('hidden');
            } else {
                const file = document.getElementById('pdf-upload').files[0];
                const reader = new FileReader();
                reader.onload = function() {
                    pdfDataArray = new Uint8Array(this.result);
                    document.getElementById('ready-student-name').textContent = studentName;
                    document.getElementById('ready-timer-info').textContent = timeLimitMinutes;
                    document.getElementById('setup-section').classList.add('hidden');
                    document.getElementById('ready-section').classList.remove('hidden');
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function initSetupUI() {
            if (hasPdfReady()) {
                var cell = document.getElementById('pdf-upload-cell');
                if (cell) cell.style.display = 'none';
                var notice = document.getElementById('embedded-pdf-notice');
                if (notice) {
                    notice.classList.remove('hidden');
                    notice.innerHTML = hasAutoLoadedPdf() ? 'âœ“ å·²è‡ªå‹•è¼‰å…¥åŒç›®éŒ„é¡Œæœ¬ï¼ˆç¶²é ç‰ˆï¼‰ï¼Œç„¡éœ€ä¸Šå‚³ PDFã€‚' : 'âœ“ å·²ä½¿ç”¨å…§å»ºé¡Œæœ¬ï¼Œç„¡éœ€ä¸Šå‚³ PDFã€‚';
                }
                document.getElementById('start-btn').textContent = 'è«‹å…ˆè¼¸å…¥å§“å';
            }
        }

        // ç¶²é ç‰ˆï¼šå¾åŒç›®éŒ„è‡ªå‹•è¼‰å…¥ PDFï¼ˆåƒ…åœ¨ http/https ä¸‹æœ‰æ•ˆï¼Œé›™æ“Šé–‹ file:// ç„¡æ•ˆï¼‰
        async function tryAutoLoadPdf() {
            if (hasEmbeddedPdf()) { initSetupUI(); return; }
            try {
                var url = 'æµé«”æ¨ç†(é›»è…¦æ¸¬é©—ç”¨é¡Œæœ¬).pdf';
                var res = await fetch(url);
                if (!res.ok) throw new Error(res.status);
                var buf = await res.arrayBuffer();
                AUTO_LOADED_PDF_ARRAY = new Uint8Array(buf);
                initSetupUI();
            } catch (e) {
                initSetupUI();
            }
        }

        async function startActualQuiz() {
            pdfDoc = await pdfjsLib.getDocument(pdfDataArray).promise;
            userAnswers = new Array(pdfDoc.numPages).fill(null);
            userAnswerStartTimes = new Array(pdfDoc.numPages).fill(null);
            userPageDurations = new Array(pdfDoc.numPages).fill(null);
            document.getElementById('ready-section').classList.add('hidden');
            document.getElementById('quiz-section').classList.remove('hidden');
            document.getElementById('student-display').textContent = `è€ƒç”Ÿï¼š${studentName}`;
            startGlobalTimer(timeLimitMinutes * 60);
            renderPage(1);
        }

        async function renderPage(num) {
            currentPage = num;
            const page = await pdfDoc.getPage(num);
            const canvas = document.getElementById('pdf-canvas');
            const viewport = page.getViewport({ scale: 1.2 });
            canvas.height = viewport.height; canvas.width = viewport.width;
            await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
            document.getElementById('page-info').textContent = `ç¬¬ ${num} / ${pdfDoc.numPages} é¡Œ`;
            userAnswerStartTimes[num - 1] = Date.now();
            startPageTimer(num);
            updateBtnHighlight();
            document.getElementById('finish-btn').style.display = (num === pdfDoc.numPages ? 'block' : 'none');
        }

        function selectOption(opt) {
            userAnswers[currentPage - 1] = opt;
            recordCurrentPageDuration();
            updateBtnHighlight();
            if (currentPage < pdfDoc.numPages) setTimeout(() => renderPage(currentPage + 1), 200);
        }

        function updateBtnHighlight() {
            const currentAns = String(userAnswers[currentPage - 1]);
            document.querySelectorAll('.opt-btn').forEach(btn => {
                btn.classList.toggle('active-btn', btn.textContent === currentAns);
            });
        }

        function startPageTimer(num) {
            if (pageTimerInterval) clearInterval(pageTimerInterval);
            const el = document.getElementById('page-timer');
            pageTimerInterval = setInterval(() => {
                const sec = Math.floor((Date.now() - userAnswerStartTimes[num-1]) / 1000);
                el.textContent = `æœ¬é¡Œç”¨æ™‚: ${sec} ç§’`;
            }, 1000);
        }

        function startGlobalTimer(seconds) {
            let timeLeft = seconds;
            timerInterval = setInterval(() => {
                const mins = Math.floor(timeLeft / 60), secs = timeLeft % 60;
                document.getElementById('timer-display').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                if (timeLeft-- <= 0) { clearInterval(timerInterval); finishQuiz(); }
            }, 1000);
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            recordCurrentPageDuration();
            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');
            
            let scoreCount = 0;
            for (let i = 0; i < pdfDoc.numPages; i++) {
                if (String(userAnswers[i]) === String(correctAnswers[i])) scoreCount++;
            }
            
            document.getElementById('result-name').textContent = studentName;
            document.getElementById('final-score').textContent = Math.round((scoreCount / pdfDoc.numPages) * 80);
            document.getElementById('report-date').textContent = new Date().toLocaleString();
            document.getElementById('result-actions').classList.remove('hidden');
        }

        document.getElementById('student-name').addEventListener('input', checkSetupCompletion);
        document.getElementById('pdf-upload').addEventListener('change', checkSetupCompletion);
        document.addEventListener('DOMContentLoaded', tryAutoLoadPdf);
        function prevPage() { if (currentPage > 1) { recordCurrentPageDuration(); renderPage(currentPage - 1); } }
        function nextPage() { if (currentPage < pdfDoc.numPages) { recordCurrentPageDuration(); renderPage(currentPage + 1); } }
    </script>
</body>
</html>